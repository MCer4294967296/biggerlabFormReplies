{% extends 'wechatted.html' %}
{% block body %}
<div class="row" style="max-height: 600px">
  <div class="col-2" style="max-height: inherit">
    {% if leftList is defined %}
    <ul class="list-group" style="max-height: inherit; margin-bottom: 10px; overflow-y: auto;">
      {% for item in leftList %}
      <li class="list-group-item list-group-item-action" id="leftList{{ item.id }}" onclick="getInfo(this)">{{ item.studentName }}</li>
      {% endfor %}
    </ul>
    {% else %}
    <h3> Index range is out of bounds. Please try to get yourself back using the buttons below. </h3>
    {% endif %}
    {% if prevLink is not none %}
    <a href="{{ prevLink }}">Prev 10</a>
    {% endif %}
    {% if nextLink is not none %}
    <a href="{{ nextLink }}">Next 10</a>
    {% endif %}
  </div>

  <div class="col-6">
    <div>
      <form>
        <textarea class="form-control" id="message2Send" rows=10></textarea>
      </form>
    </div>
    <div>
      <button class="btn btn-primary" id="sendButton" onclick="sendToWechat()">Send</button>
      <!--<button class="btn btn-primary" id="saveButton">Save</button>-->
    </div>
    <div style="text-align: left">
      <div class="row">
        <div class="col" style="text-align: right"><label>MesssageID</label></div>
        <div class="col"><label id="msgID"></label></div>
      </div>
      <div class="row">
        <div class="col" style="text-align: right"><label>Student Name</label></div>
        <div class="col"><label id="studentName"></label></div>
      </div>
      <div class="row">
        <div class="col" style="text-align: right"><label>Teacher Name</label></div>
        <div class="col"><label id="teacherName"></label></div>
      </div>
      <div class="row">
        <div class="col" style="text-align: right"><label>Message is edited</label></div>
        <div class="col"><label id="messageEdited"></label></div>
      </div>
      <div class="row">
        <div class="col" style="text-align: right"><label>Reason Filling</label></div>
        <div class="col"><label id="reasonFilling"></label></div>
      </div>
    </div>
  </div>
{% block wechatList %}{{ super() }}{% endblock %}
</div>
{% endblock %}
{% block script %}
{{ super() }}
<script>
function makeToTop(listItem) {
  var par = listItem.parentElement;
  par.removeChild(listItem);
  par.insertBefore(listItem, par.children[0]);
}

function getInfo(elem) {
  var id = elem.id.slice(8);
  var url = "/BiggerlabCourseFeedback/getDoc?id=" + id;
  
  var xhr = new XMLHttpRequest;
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
      [].forEach.call(document.getElementsByClassName("list-group-item-action active"),
        function (btn) {
          if (btn.id.startsWith("leftList")) {
            btn.classList.remove("active")
          }});
        
      var jsonData = JSON.parse(xhr.responseText);
      document.getElementById("msgID").textContent = jsonData.id;
      document.getElementById("message2Send").value = jsonData.message;
      document.getElementById("studentName").textContent = jsonData.studentName;
      document.getElementById("teacherName").textContent = jsonData.teacherName;
      document.getElementById("messageEdited").textContent = jsonData.messageEdited;
      document.getElementById("reasonFilling").textContent = jsonData.reasonFilling;
      document.getElementById("leftList"+id).classList.add("active");
      for (item of wechatContactList) {
        if (item.id.includes(jsonData.studentName)) {
          makeToTop(item);
          var proxy = new Object();
          proxy.target = item;
          wechatContactClick(proxy);
        }
      }
    }
  }
  xhr.open("GET", url, true);
  xhr.send();
}

var wechatServer = "/BiggerlabCourseFeedback/sendToWechat";


</script>
{% endblock %}